<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://github.com/accenture/mercury/guides/APPENDIX-III/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Appendix-III - Mercury</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Appendix-III";
        var mkdocs_page_input_path = "guides/APPENDIX-III.md";
        var mkdocs_page_url = "/accenture/mercury/guides/APPENDIX-III/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Mercury
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../TABLE-OF-CONTENTS/">Contents</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-1/">Chapter-1</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-2/">Chapter-2</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-3/">Chapter-3</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-4/">Chapter-4</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-5/">Chapter-5</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-6/">Chapter-6</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-7/">Chapter-7</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-8/">Chapter-8</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-9/">Chapter-9</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-10/">Chapter-10</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../APPENDIX-I/">Appendix-I</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../APPENDIX-II/">Appendix-II</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Appendix-III</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#actuator-endpoints">Actuator endpoints</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#custom-health-services">Custom health services</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#asynchttpclient-service">AsyncHttpClient service</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#send-http-request-body-for-http-put-post-and-patch-methods">Send HTTP request body for HTTP PUT, POST and PATCH methods</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#send-http-request-body-as-a-stream">Send HTTP request body as a stream</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#read-http-response-body-stream">Read HTTP response body stream</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#content-length-for-http-request">Content length for HTTP request</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../CHANGELOG/">Release notes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../arch-decisions/DESIGN-NOTES/">Design notes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../INCLUSIVITY/">Inclusivity</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../CODE_OF_CONDUCT/">Code of Conduct</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../CONTRIBUTING/">Contribution</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../ROADMAP/">Roadmap</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Mercury</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Appendix-III</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="actuators-and-http-client">Actuators and HTTP client</h1>
<h2 id="actuator-endpoints">Actuator endpoints</h2>
<p>The following admin endpoints are available.</p>
<pre><code>GET /info
GET /info/routes
GET /info/lib
GET /env
GET /health
GET /livenessprobe
POST /shutdown
</code></pre>
<table>
<thead>
<tr>
<th style="text-align: left;">Endpoint</th>
<th style="text-align: left;">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">/info</td>
<td style="text-align: left;">Describe the application</td>
</tr>
<tr>
<td style="text-align: left;">/info/routes</td>
<td style="text-align: left;">Show public routing table</td>
</tr>
<tr>
<td style="text-align: left;">/info/lib</td>
<td style="text-align: left;">List libraries packed with this executable</td>
</tr>
<tr>
<td style="text-align: left;">/env</td>
<td style="text-align: left;">List all private and public function route names and selected environment variables</td>
</tr>
<tr>
<td style="text-align: left;">/health</td>
<td style="text-align: left;">Application health check endpoint</td>
</tr>
<tr>
<td style="text-align: left;">/livenessprobe</td>
<td style="text-align: left;">Check if application is running normally</td>
</tr>
<tr>
<td style="text-align: left;">/shutdown</td>
<td style="text-align: left;">Operator may use this endpoint to do a POST command to stop the application</td>
</tr>
</tbody>
</table>
<p>For the shutdown endpoint, you must provide an <code>X-App-Instance</code> HTTP header where the value is the "origin ID"
of the application. You can get the value from the "/info" endpoint.</p>
<h2 id="custom-health-services">Custom health services</h2>
<p>You can extend the "/health" endpoint by implementing and registering lambda functions to be added to the 
"health check" dependencies.</p>
<pre><code class="language-properties">mandatory.health.dependencies=cloud.connector.health, demo.health
optional.health.dependencies=other.service.health
</code></pre>
<p>Your custom health service must respond to the following requests:</p>
<ol>
<li>Info request (type=info) - it should return a map that includes service name and href (protocol, hostname and port)</li>
<li>Health check (type=health) - it should return a text string of the health check. e.g. read/write test result. 
   It can throw AppException with status code and error message if health check fails.</li>
</ol>
<p>A sample health service is available in the <code>DemoHealth</code> class of the <code>lambda-example</code> project as follows:</p>
<pre><code class="language-java">@PreLoad(route=&quot;demo.health&quot;, instances=5)
public class DemoHealth implements LambdaFunction {

    private static final String TYPE = &quot;type&quot;;
    private static final String INFO = &quot;info&quot;;
    private static final String HEALTH = &quot;health&quot;;

    @Override
    public Object handleEvent(Map&lt;String, String&gt; headers, Object input, int instance) {
        /*
         * The interface contract for a health check service includes both INFO and HEALTH responses
         */
        if (INFO.equals(headers.get(TYPE))) {
            Map&lt;String, Object&gt; result = new HashMap&lt;&gt;();
            result.put(&quot;service&quot;, &quot;demo.service&quot;);
            result.put(&quot;href&quot;, &quot;http://127.0.0.1&quot;);
            return result;
        }
        if (HEALTH.equals(headers.get(TYPE))) {
            /*
             * This is a place-holder for checking a downstream service.
             *
             * You may implement your own logic to test if a downstream service is running fine.
             * If running, just return a health status message.
             * Otherwise,
             *      throw new AppException(status, message)
             */
            return &quot;demo.service is running fine&quot;;
        }
        throw new IllegalArgumentException(&quot;type must be info or health&quot;);
    }
}

</code></pre>
<h2 id="asynchttpclient-service">AsyncHttpClient service</h2>
<p>The "async.http.request" function can be used as a non-blocking HTTP client.</p>
<p>To make an HTTP request to an external REST endpoint, you can create an HTTP request object using the
<code>AsyncHttpRequest</code> class and make an async RPC call to the "async.http.request" function like this:</p>
<pre><code class="language-java">PostOffice po = new PostOffice(headers, instance);
AsyncHttpRequest req = new AsyncHttpRequest();
req.setMethod(&quot;GET&quot;);
req.setHeader(&quot;accept&quot;, &quot;application/json&quot;);
req.setUrl(&quot;/api/hello/world?hello world=abc&quot;);
req.setQueryParameter(&quot;x1&quot;, &quot;y&quot;);
List&lt;String&gt; list = new ArrayList&lt;&gt;();
list.add(&quot;a&quot;);
list.add(&quot;b&quot;);
req.setQueryParameter(&quot;x2&quot;, list);
req.setTargetHost(&quot;http://127.0.0.1:8083&quot;);
EventEnvelope request = new EventEnvelope().setTo(&quot;async.http.request&quot;).setBody(req);
Future&lt;EventEnvelope&gt; res = po.asyncRequest(request, 5000);
res.onSuccess(response -&gt; {
   // do something with the result 
});
</code></pre>
<p>In a suspend function using KotlinLambdaFunction, the same logic may look like this:</p>
<pre><code class="language-kotlin">val fastRPC = FastRPC(headers)
val req = AsyncHttpRequest()
req.setMethod(&quot;GET&quot;)
req.setHeader(&quot;accept&quot;, &quot;application/json&quot;)
req.setUrl(&quot;/api/hello/world?hello world=abc&quot;)
req.setQueryParameter(&quot;x1&quot;, &quot;y&quot;)
val list: MutableList&lt;String&gt; = ArrayList()
list.add(&quot;a&quot;)
list.add(&quot;b&quot;)
req.setQueryParameter(&quot;x2&quot;, list)
req.setTargetHost(&quot;http://127.0.0.1:8083&quot;)
val request = EventEnvelope().setTo(&quot;async.http.request&quot;).setBody(req)
val response = fastRPC.awaitRequest(request, 5000)
// do something with the result
</code></pre>
<h3 id="send-http-request-body-for-http-put-post-and-patch-methods">Send HTTP request body for HTTP PUT, POST and PATCH methods</h3>
<p>For most cases, you can just set a HashMap into the request body and specify content-type as JSON or XML.
The system will perform serialization properly.</p>
<p>Example code may look like this:</p>
<pre><code class="language-java">AsyncHttpRequest req = new AsyncHttpRequest();
req.setMethod(&quot;POST&quot;);
req.setHeader(&quot;accept&quot;, &quot;application/json&quot;);
req.setHeader(&quot;content-type&quot;, &quot;application/json&quot;);
req.setUrl(&quot;/api/book&quot;);
req.setTargetHost(&quot;https://service_provider_host&quot;);
req.setBody(mapOfKeyValues);
// where keyValues is a HashMap
</code></pre>
<h2 id="send-http-request-body-as-a-stream">Send HTTP request body as a stream</h2>
<p>For larger payload, you may use the streaming method. See sample code below:</p>
<pre><code class="language-java">int len;
byte[] buffer = new byte[4096];
FileInputStream in = new FileInputStream(myFile);
ObjectStreamIO stream = new ObjectStreamIO(timeoutInSeconds);
ObjectStreamWriter out = stream.getOutputStream();
while ((len = in.read(buffer, 0, buffer.length)) != -1) {
    out.write(buffer, 0, len);
}
// closing the output stream would send a EOF signal to the stream
out.close();
// tell the HTTP client to read the input stream
req.setStreamRoute(stream.getInputStreamId());
</code></pre>
<h2 id="read-http-response-body-stream">Read HTTP response body stream</h2>
<p>If content length is not given, the response body will be received as a stream.</p>
<p>Your application should check if the HTTP response header "stream" exists. Its value is an input "stream ID".</p>
<p>For simplicity and readability, we recommend using "suspend function" to read the input byte-array stream.</p>
<p>It may look like this:</p>
<pre><code class="language-kotlin">val po = PostOffice(headers, instance)
val fastRPC = FastRPC(headers)

val req = EventEnvelope().setTo(streamId).setHeader(&quot;type&quot;, &quot;read&quot;)
while (true) {
    val event = fastRPC.awaitRequest(req, 5000)
    if (event.status == 408) {
        // handle input stream timeout
        break
    }
    if (&quot;eof&quot; == event.headers[&quot;type&quot;]) {
        po.send(streamId, Kv(&quot;type&quot;, &quot;close&quot;))
        break
    }
    if (&quot;data&quot; == event.headers[&quot;type&quot;]) {
        val block = event.body
        if (block is ByteArray) {
            // handle the data block from the input stream
        }
    }
}
</code></pre>
<h2 id="content-length-for-http-request">Content length for HTTP request</h2>
<p>IMPORTANT: Do not set the "content-length" HTTP header because the system will automatically compute the
correct content-length for small payload. For large payload, it will use the chunking method.
<br/></p>
<table>
<thead>
<tr>
<th style="text-align: center;">Appendix-II</th>
<th style="text-align: center;">Home</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><a href="../APPENDIX-II/">Reserved Route Names</a></td>
<td style="text-align: center;"><a href="../TABLE-OF-CONTENTS/">Table of Contents</a></td>
</tr>
</tbody>
</table>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../APPENDIX-II/" class="btn btn-neutral float-left" title="Appendix-II"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../CHANGELOG/" class="btn btn-neutral float-right" title="Release notes">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../APPENDIX-II/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../CHANGELOG/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
